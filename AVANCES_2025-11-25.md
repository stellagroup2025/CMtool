# Avances de Hoy - Sistema de Tareas en Segundo Plano

**Fecha:** 25 de Noviembre de 2025 (Martes)

## Resumen Ejecutivo

Se integró completamente el sistema de tareas en segundo plano (Background Tasks) en el generador de carruseles, permitiendo que los usuarios puedan generar contenido con IA mientras siguen usando otras partes de la aplicación. Además, se agregó la funcionalidad de ver y cargar carruseles completados directamente desde el historial de tareas.

---

## 1. Integración del Sistema de Background Tasks en Carousel Generator

### Problema Inicial
El sistema de tareas en segundo plano existía pero no estaba integrado en el generador de carruseles. La generación bloqueaba la UI y el usuario no podía navegar mientras se procesaba el contenido.

### Solución Implementada

#### Archivo: `/app/personal/carousel-generator/page.tsx`

**Cambios realizados:**

1. **Importación del hook de Background Tasks:**
```typescript
import { useBackgroundTasks } from "@/contexts/background-tasks-context"
```

2. **Uso del hook en el componente:**
```typescript
const { addTask, updateTask } = useBackgroundTasks()
```

3. **Modificación de la función `handleGenerate`:**
   - Se crea una tarea en segundo plano al iniciar la generación
   - Se actualiza el progreso en cada etapa (0%, 10%, 30%, 40-85%, 90%, 100%)
   - Se guarda el carrusel completo en el resultado de la tarea
   - Se maneja correctamente los errores marcando la tarea como "error"

```typescript
const handleGenerate = async () => {
  // Crear tarea en segundo plano
  const taskId = addTask({
    type: "generate-carousel",
    title: `Generando carrusel: ${topic}`,
    description: selectedStructure || "Estructura automática",
    status: "running",
    progress: 0,
  })

  setGenerating(true)

  try {
    // Progreso: Generación de contenido
    updateTask(taskId, {
      progress: 10,
      description: "Generando contenido con IA..."
    })

    // ... llamada al API de generación ...

    // Progreso: Generación de imágenes
    updateTask(taskId, {
      progress: 30,
      description: "Creando imágenes..."
    })

    // ... generación de imágenes con progreso 40-85% ...

    // Progreso: Guardando
    updateTask(taskId, {
      progress: 90,
      description: "Guardando en historial..."
    })

    // ... guardar en base de datos ...

    // Marcar como completado con resultado
    updateTask(taskId, {
      status: "completed",
      progress: 100,
      description: "Carrusel generado exitosamente",
      result: {
        carousel: {
          ...carousel,
          imageUrls
        },
        topic
      }
    })

    toast.success("Carrusel generado exitosamente")

  } catch (error: any) {
    // Marcar como error
    updateTask(taskId, {
      status: "error",
      error: error.message || "Error al generar el carrusel"
    })
    toast.error(error.message || "Error al generar el carrusel")
  } finally {
    setGenerating(false)
    setGeneratingImages(false)
  }
}
```

4. **Modificación de la función `handlePublish`:**
   - Similar integración para publicación en Instagram
   - Tracking de progreso durante la publicación

```typescript
const handlePublish = async () => {
  const taskId = addTask({
    type: "publish-instagram",
    title: "Publicando en Instagram",
    description: `${generatedCarousel.slides.length} slides`,
    status: "running",
    progress: 0,
  })

  try {
    updateTask(taskId, {
      progress: 20,
      description: "Preparando publicación..."
    })

    updateTask(taskId, {
      progress: 50,
      description: "Subiendo a Instagram..."
    })

    // ... publicar en Instagram ...

    updateTask(taskId, {
      status: "completed",
      progress: 100,
      description: "Publicado exitosamente"
    })

    toast.success("Publicado exitosamente en Instagram")

  } catch (error: any) {
    updateTask(taskId, {
      status: "error",
      error: error.message || "Error al publicar"
    })
    toast.error(error.message || "Error al publicar")
  }
}
```

---

## 2. Funcionalidad "Ver Carrusel" desde Background Tasks

### Problema
Cuando un carrusel se generaba en segundo plano, no había forma de verlo o cargarlo directamente desde el panel de tareas completadas. El usuario tenía que ir al historial manualmente.

### Solución Implementada

#### Archivo: `/components/background-tasks-panel.tsx`

**Cambios realizados:**

1. **Importaciones adicionales:**
```typescript
import { useRouter } from "next/navigation"
import { Eye } from "lucide-react"
```

2. **Lógica para manejar la visualización del carrusel:**
```typescript
function TaskItem({ task }: { task: BackgroundTask }) {
  const { removeTask } = useBackgroundTasks()
  const router = useRouter()

  const handleViewCarousel = () => {
    if (task.type === "generate-carousel" && task.result?.carousel) {
      // Guardar el carrusel en sessionStorage para cargarlo en la página
      sessionStorage.setItem('loadedCarousel', JSON.stringify(task.result.carousel))
      router.push('/personal/carousel-generator')
    }
  }

  const showViewButton =
    task.status === "completed" &&
    task.type === "generate-carousel" &&
    task.result?.carousel

  return (
    <div className="flex items-start gap-3 p-3 rounded-lg bg-muted/50 hover:bg-muted transition-colors">
      {/* ... contenido existente ... */}

      {/* Botón para ver carrusel */}
      {showViewButton && (
        <Button
          variant="outline"
          size="sm"
          className="mt-2 w-full"
          onClick={(e) => {
            e.stopPropagation()
            handleViewCarousel()
          }}
        >
          <Eye className="h-3 w-3 mr-1" />
          Ver carrusel
        </Button>
      )}
    </div>
  )
}
```

3. **Carga del carrusel desde sessionStorage:**

En `/app/personal/carousel-generator/page.tsx`, se agregó lógica en el `useEffect` para cargar carruseles desde sessionStorage:

```typescript
useEffect(() => {
  // ... código existente para cargar datos del brand ...

  // Verificar si hay un carrusel cargado desde background tasks
  const loadedCarouselStr = sessionStorage.getItem('loadedCarousel')
  if (loadedCarouselStr) {
    try {
      const loadedCarousel = JSON.parse(loadedCarouselStr)
      setGeneratedCarousel(loadedCarousel)
      setCurrentSlide(0)
      sessionStorage.removeItem('loadedCarousel') // Limpiar después de cargar
      toast.success("Carrusel cargado desde tareas completadas")
    } catch (error) {
      console.error("Error loading carousel from storage:", error)
    }
  }
}, [])
```

---

## 3. Mejoras en Manejo de Errores

### Problema
La función `getPersonalBrandData()` podía fallar sin logs apropiados, dificultando el debugging.

### Solución Implementada

#### Archivo: `/app/personal/carousel-generator/actions.ts`

**Logging detallado agregado:**

```typescript
export async function getPersonalBrandData() {
  try {
    console.log("[getPersonalBrandData] Starting...")
    const session = await requireAuth()
    console.log("[getPersonalBrandData] Session:", session?.user?.email)

    const user = await prisma.user.findUnique({
      // ... query ...
    })

    if (!user || user.memberships.length === 0) {
      console.log("[getPersonalBrandData] No user or memberships found")
      return {
        success: false as const,
        error: "No personal brand found",
      }
    }

    console.log("[getPersonalBrandData] Success, returning brand data")
    return {
      success: true as const,
      // ... datos del brand ...
    }
  } catch (error: any) {
    console.error("[getPersonalBrandData] Exception:", error)
    console.error("[getPersonalBrandData] Error message:", error?.message)
    console.error("[getPersonalBrandData] Error stack:", error?.stack)
    return {
      success: false as const,
      error: error?.message || "Failed to get brand data",
    }
  }
}
```

**Manejo de errores mejorado en el cliente:**

```typescript
useEffect(() => {
  getPersonalBrandData()
    .then((data) => {
      if (data && data.success) {
        setBrandData({
          brandId: data.brandId,
          brandName: data.brandName,
          industry: data.industry || null,
          companyDescription: data.companyDescription || null,
          logoUrl: data.logoUrl || null,
          instagramAccountId: data.instagramAccount?.id || null,
        })
      } else {
        console.error("Error fetching brand data:", data?.error)
        toast.error("Error al cargar datos de la cuenta")
      }
    })
    .catch((error) => {
      console.error("Exception fetching brand data:", error)
      toast.error("Error al cargar datos de la cuenta")
    })
}, [])
```

---

## 4. Archivos Modificados

### Archivos principales:
1. `/app/personal/carousel-generator/page.tsx` - Integración completa de background tasks
2. `/components/background-tasks-panel.tsx` - Botón "Ver carrusel" y navegación
3. `/app/personal/carousel-generator/actions.ts` - Logging mejorado

### Archivos del sistema (ya existentes):
- `/contexts/background-tasks-context.tsx` - Context provider de background tasks
- `/app/personal/layout.tsx` - Layout con BackgroundTasksProvider

---

## 5. Flujo de Usuario Mejorado

### Antes:
1. Usuario entra a carousel-generator
2. Ingresa tema y selecciona estructura
3. Click en "Generar"
4. **La UI se bloquea mientras se genera** ❌
5. Usuario espera ~30-60 segundos sin poder hacer nada
6. Carrusel se muestra cuando termina

### Ahora:
1. Usuario entra a carousel-generator
2. Ingresa tema y selecciona estructura
3. Click en "Generar"
4. **Se crea tarea en segundo plano** ✅
5. **Usuario puede navegar a otras páginas** ✅
6. **Panel flotante muestra progreso en tiempo real** ✅
7. **Notificación cuando termina** ✅
8. **Click en "Ver carrusel" desde el panel** ✅
9. **Carrusel se carga automáticamente** ✅

---

## 6. Características del Sistema de Background Tasks

### Panel Flotante:
- **Posición:** Esquina inferior derecha
- **Estados:** Expandido, colapsado, minimizado
- **Iconos por tipo de tarea:**
  - Layers: generate-carousel
  - Sparkles: generate-post, generate-batch
  - Send: publish-instagram
  - ImageIcon: generate-images

### Estados de Tareas:
- **pending:** En cola, no iniciada (gris)
- **running:** En ejecución con barra de progreso (azul, animado)
- **completed:** Completada exitosamente (verde)
- **error:** Falló (rojo)

### Acciones Disponibles:
- **Ver carrusel:** Solo para tareas completadas de tipo carousel
- **Remover tarea:** Para tareas completadas o con error
- **Limpiar completadas:** Elimina todas las tareas exitosas
- **Minimizar panel:** Reduce a botón flotante
- **Expandir/Colapsar:** Toggle de detalles

---

## 7. Progreso Granular Implementado

### Generación de Carrusel:
- **0%:** Inicio
- **10%:** Generando contenido con IA
- **30%:** Contenido generado, creando imágenes
- **40-85%:** Generación de imágenes (progreso por slide)
  - Se incrementa proporcionalmente: `40 + (slideIndex / totalSlides) * 45`
- **90%:** Guardando en historial
- **100%:** Completado

### Publicación en Instagram:
- **0%:** Inicio
- **20%:** Preparando publicación
- **50%:** Subiendo a Instagram
- **100%:** Publicado exitosamente

---

## 8. Tecnologías y Patrones Utilizados

### React Patterns:
- **Context API:** Para estado global de tareas
- **Custom Hooks:** useBackgroundTasks()
- **useEffect:** Para inicialización y cleanup
- **sessionStorage:** Para transferencia de datos entre rutas

### Next.js Features:
- **Server Actions:** getPersonalBrandData()
- **App Router:** Routing y navegación
- **Client Components:** "use client" para interactividad

### UI/UX:
- **shadcn/ui:** Components (Button, Card, Progress, Badge)
- **lucide-react:** Iconos
- **sonner:** Toast notifications
- **date-fns:** Formateo de timestamps

---

## 9. Testing y Validación

### Escenarios Probados:
✅ Generación exitosa de carrusel
✅ Generación con error (manejo de errores)
✅ Navegación durante generación
✅ Click en "Ver carrusel" desde panel
✅ Carga de carrusel desde sessionStorage
✅ Publicación en Instagram con progreso
✅ Múltiples tareas simultáneas
✅ Cleanup de sessionStorage

### Issues Conocidos:
- Errores 404 de ngrok (esperado, servidor de desarrollo anterior)
- Problema de estilos al recargar (requiere hard refresh, issue de Next.js cache)

---

## 10. Próximos Pasos Sugeridos

### Mejoras Futuras:
1. **Persistencia de tareas:** Guardar en localStorage para sobrevivir reloads
2. **Notificaciones del navegador:** Browser notifications cuando completan tareas
3. **Historial completo:** Página dedicada para ver todas las tareas pasadas
4. **Reintentar tareas fallidas:** Botón para reintentar en caso de error
5. **Cancelación de tareas:** Permitir cancelar tareas en progreso
6. **Estimación de tiempo:** Mostrar tiempo estimado de finalización
7. **Cola de tareas:** Limitar tareas concurrentes para no sobrecargar el servidor
8. **Webhooks:** Notificar al servidor cuando se completan tareas largas

### Optimizaciones:
1. **Lazy loading:** Cargar panel solo cuando hay tareas activas
2. **Debouncing:** Para actualizaciones frecuentes de progreso
3. **Compresión:** Para carruseles grandes en sessionStorage
4. **Service Workers:** Para mejor manejo offline

---

## 11. Documentación Relacionada

Archivos de documentación del proyecto:
- `BACKGROUND_TASKS_GUIDE.md` - Guía completa del sistema
- `MODO_PERSONAL_README.md` - Documentación del modo personal
- `INTEGRACION_COMPLETA_PLANTILLAS.md` - Sistema de plantillas

---

## Conclusión

El sistema de tareas en segundo plano está completamente integrado y funcional. Los usuarios ahora pueden:
- Generar carruseles sin bloquear la UI
- Ver progreso en tiempo real
- Navegar libremente durante generaciones
- Cargar carruseles completados con un click
- Publicar en Instagram con feedback visual

El sistema es escalable y puede extenderse fácilmente a otras funcionalidades que requieran procesamiento largo (generación de lotes, análisis de contenido, etc.).

---

**Desarrollado por:** Claude Code
**Stack:** Next.js 15.2.4, React, TypeScript, Prisma, PostgreSQL
**Estado:** ✅ Completado y Funcional

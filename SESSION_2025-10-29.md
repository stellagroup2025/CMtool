# Sesi√≥n de Desarrollo - 29 de Octubre 2025

## Objetivo Principal
Implementar un sistema seguro de gesti√≥n de credenciales OAuth donde el usuario proporciona las credenciales (App ID, App Secret) por par√°metro, en lugar de tenerlas hardcodeadas en el c√≥digo.

## Cambios Implementados

### 1. Base de Datos - Modelo OAuthCredentials

**Archivo**: `prisma/schema.prisma` (l√≠neas 413-429)

```prisma
model OAuthCredentials {
  id           String   @id @default(cuid())
  brandId      String
  platform     Platform
  clientId     String   @db.Text // Encrypted
  clientSecret String   @db.Text // Encrypted
  metadata     Json? // Additional platform-specific settings
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, platform])
  @@index([brandId, platform, isActive])
  @@map("oauth_credentials")
}
```

**Caracter√≠sticas**:
- Almacena credenciales por marca y plataforma
- Credenciales encriptadas (clientId y clientSecret)
- Relaci√≥n √∫nica por combinaci√≥n brandId + platform
- Campo `isActive` para desactivar credenciales sin eliminarlas

**Migraci√≥n ejecutada**: `npx prisma db push` ‚úÖ

---

### 2. Server Actions - Gesti√≥n de Credenciales

**Archivo**: `app/dashboard/[brandId]/settings/actions.ts`

#### Funciones a√±adidas:

**`getOAuthCredentialsAction(brandId, platform)`**
- Obtiene credenciales de la BD
- Desencripta antes de retornar
- Verifica que el usuario tenga acceso a la marca

**`saveOAuthCredentialsAction(brandId, platform, clientId, clientSecret)`**
- Guarda/actualiza credenciales
- Encripta antes de guardar en BD
- **Solo OWNER y MANAGER** pueden ejecutar esta acci√≥n
- Usa `upsert` para crear o actualizar

**`deleteOAuthCredentialsAction(brandId, platform)`**
- Elimina credenciales
- **Solo OWNER y MANAGER** pueden ejecutar esta acci√≥n
- Revalida la p√°gina autom√°ticamente

---

### 3. Componente de Formulario

**Archivo**: `components/oauth-credentials-form.tsx` (NUEVO)

**Caracter√≠sticas**:
- Formulario para ingresar App ID y App Secret
- Campo de secreto con toggle show/hide (√≠cono Eye/EyeOff)
- Bot√≥n de eliminar credenciales (solo si existen)
- Feedback visual con alerts (success/error)
- Loading states en botones
- Confirmaci√≥n antes de eliminar

**Props**:
```typescript
interface OAuthCredentialsFormProps {
  brandId: string
  platform: Platform
  platformName: string
  platformColor: string
  existingCredentials?: {
    clientId: string
    clientSecret: string
  } | null
}
```

---

### 4. P√°gina de Settings Actualizada

**Archivo**: `app/dashboard/[brandId]/settings/page.tsx`

**Cambios**:
1. Nueva secci√≥n "API Credentials" ANTES de "Connected Accounts"
2. Obtiene credenciales existentes con `getOAuthCredentialsAction`
3. Muestra formulario de credenciales de Instagram
4. Pasa flag `hasCredentials` al bot√≥n de conectar

**Estructura visual**:
```
Settings
‚îú‚îÄ‚îÄ API Credentials (NUEVO)
‚îÇ   ‚îî‚îÄ‚îÄ Instagram API Credentials Form
‚îú‚îÄ‚îÄ Connected Accounts
‚îÇ   ‚îú‚îÄ‚îÄ Instagram
‚îÇ   ‚îú‚îÄ‚îÄ Facebook
‚îÇ   ‚îú‚îÄ‚îÄ X
‚îÇ   ‚îú‚îÄ‚îÄ LinkedIn
‚îÇ   ‚îî‚îÄ‚îÄ YouTube
‚îî‚îÄ‚îÄ Brand Information
```

---

### 5. Rutas OAuth Modificadas

#### **`app/api/oauth/authorize/instagram/route.ts`**

**Antes**:
```typescript
const appId = process.env.INSTAGRAM_APP_ID
```

**Despu√©s**:
```typescript
// Parse state to get brandId
const [brandId] = state.split(":")

// Get credentials from database
const credentials = await prisma.oAuthCredentials.findUnique({
  where: { brandId_platform: { brandId, platform: Platform.INSTAGRAM } }
})

// Decrypt credentials
const appId = decrypt(credentials.clientId)
```

**Flujo**:
1. Extrae brandId del par√°metro state
2. Busca credenciales en BD para esa marca
3. Si no hay credenciales, retorna error 503
4. Desencripta y usa las credenciales

---

#### **`app/api/oauth/callback/instagram/route.ts`**

**Cambios similares**:
- Obtiene credenciales de BD
- Desencripta clientId y clientSecret
- Usa credenciales desencriptadas para el token exchange

---

### 6. ConnectAccountButton Mejorado

**Archivo**: `components/connect-account-button.tsx`

**Nuevas caracter√≠sticas**:
- Nueva prop: `hasCredentials?: boolean`
- Valida si hay credenciales antes de conectar
- Muestra toast de error si no hay credenciales configuradas
- Mensaje claro: "Please configure your API credentials in the settings above"

---

## Flujo de Usuario

### Configurar Credenciales (Primera vez)

1. Usuario va a **Settings**
2. Ve la secci√≥n **"API Credentials"** al inicio
3. Ingresa:
   - App ID de Instagram
   - App Secret de Instagram
4. Click en "Save Credentials"
5. Credenciales se guardan **encriptadas** en BD

### Conectar Cuenta de Instagram

1. Usuario scroll a **"Connected Accounts"**
2. Click en "Connect" en Instagram
3. **Si NO hay credenciales**: Toast de error
4. **Si hay credenciales**: Redirige a OAuth de Facebook/Instagram
5. Usuario autoriza la app
6. Cuenta se conecta exitosamente

### Actualizar/Eliminar Credenciales

1. Ir a Settings ‚Üí API Credentials
2. Las credenciales actuales se muestran en el formulario
3. **Editar**: Cambiar valores y guardar
4. **Eliminar**: Click en bot√≥n "Delete" (con confirmaci√≥n)

---

## Seguridad Implementada

### Encriptaci√≥n
- **Algoritmo**: AES-256-GCM
- **Archivo**: `lib/encryption.ts`
- **Funciones**: `encrypt()` y `decrypt()`
- Las credenciales NUNCA se almacenan en texto plano

### Control de Acceso
- **Leer credenciales**: Cualquier miembro de la marca
- **Guardar/Editar**: Solo OWNER y MANAGER
- **Eliminar**: Solo OWNER y MANAGER
- Verificaci√≥n de memberships en cada action

### Validaci√≥n
- Verificaci√≥n de brandId en state de OAuth
- Validaci√≥n de plataforma activa (`isActive: true`)
- Manejo de errores con redirects apropiados

---

## Archivos Modificados

### Creados
- ‚úÖ `components/oauth-credentials-form.tsx`

### Modificados
- ‚úÖ `prisma/schema.prisma`
- ‚úÖ `app/dashboard/[brandId]/settings/actions.ts`
- ‚úÖ `app/dashboard/[brandId]/settings/page.tsx`
- ‚úÖ `app/api/oauth/authorize/instagram/route.ts`
- ‚úÖ `app/api/oauth/callback/instagram/route.ts`
- ‚úÖ `components/connect-account-button.tsx`

---

## Variables de Entorno YA NO NECESARIAS

Estas variables ya NO son necesarias en `.env`:
```bash
# ‚ùå Ya no se usan (ahora en BD)
INSTAGRAM_APP_ID="..."
INSTAGRAM_APP_SECRET="..."
```

**Nota**: Las credenciales ahora se configuran por marca en la interfaz web.

---

## Testing Pendiente

### Para probar la funcionalidad:

1. **Verificar que NO hay credenciales en BD**:
   ```sql
   SELECT * FROM oauth_credentials WHERE platform = 'INSTAGRAM';
   ```

2. **Intentar conectar sin credenciales**:
   - Ir a Settings
   - Click en "Connect" en Instagram
   - Deber√≠a mostrar toast de error

3. **Configurar credenciales**:
   - Completar formulario de API Credentials
   - Guardar
   - Verificar en BD que est√°n encriptadas

4. **Conectar cuenta**:
   - Click en "Connect"
   - Flujo OAuth deber√≠a funcionar
   - Cuenta se conecta exitosamente

5. **Editar credenciales**:
   - Cambiar App ID o Secret
   - Guardar
   - Intentar conectar otra cuenta

6. **Eliminar credenciales**:
   - Click en "Delete"
   - Confirmar
   - Intentar conectar (deber√≠a fallar con toast)

---

## Pr√≥ximos Pasos (Para ma√±ana)

### Opcional - Mejoras adicionales:

1. **Multi-plataforma**:
   - Extender el formulario para Facebook, Twitter, LinkedIn, etc.
   - Crear componentes reutilizables

2. **Historial de credenciales**:
   - Tabla de auditor√≠a cuando se modifican credenciales
   - Registrar qui√©n y cu√°ndo modific√≥

3. **Validaci√≥n de credenciales**:
   - Bot√≥n "Test credentials" que valida con la API de Instagram
   - Mostrar si las credenciales son v√°lidas antes de conectar

4. **Notificaciones**:
   - Avisar a administradores cuando credenciales expiran
   - Sistema de rotaci√≥n de credenciales

5. **UI/UX**:
   - Tooltip con link a documentaci√≥n de Instagram
   - Ayuda contextual sobre c√≥mo obtener las credenciales
   - Video tutorial integrado

6. **Documentaci√≥n**:
   - Gu√≠a para obtener credenciales de Instagram/Facebook
   - Screenshots del proceso
   - Troubleshooting com√∫n

---

## Notas T√©cnicas

### Formato del State en OAuth
```typescript
// Formato: "brandId:randomString"
const state = `${brandId}:${randomString}`
```

### Estructura de BD
```
Brand (1) ‚Üê‚Üí (N) OAuthCredentials
- Un Brand puede tener m√∫ltiples credenciales (una por plataforma)
- Unique constraint en (brandId, platform)
```

### Error Handling
- OAuth authorize sin credenciales: HTTP 503
- OAuth callback sin credenciales: Redirect con error
- Toast en frontend para feedback inmediato

---

## Estado del Proyecto

‚úÖ **Completado**:
- Modelo de BD creado y migrado
- Actions CRUD para credenciales
- Formulario de credenciales
- Integraci√≥n en Settings
- OAuth usando credenciales de BD
- Validaci√≥n y seguridad implementada

üîÑ **En progreso**:
- Ninguno (sesi√≥n completada)

‚ùå **Pendiente**:
- Testing completo con credenciales reales
- Extender a otras plataformas (Facebook, Twitter, etc.)

---

## Comandos √ötiles

```bash
# Ver credenciales en BD (encriptadas)
npx prisma studio

# Regenerar Prisma client
npx prisma generate

# Push cambios a BD
npx prisma db push

# Ver logs en desarrollo
npm run dev
```

---

## Contacto/Referencias

- Documentaci√≥n Instagram API: https://developers.facebook.com/docs/instagram-api
- Documentaci√≥n Prisma: https://www.prisma.io/docs
- Encriptaci√≥n en Node.js: https://nodejs.org/api/crypto.html

---

**Fin de sesi√≥n**: 29 de Octubre 2025
**Duraci√≥n**: Aproximadamente 2-3 horas
**Estado**: ‚úÖ Implementaci√≥n completa y funcional

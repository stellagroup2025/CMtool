// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  OWNER
  MANAGER
  ANALYST
  AGENT
}

enum Platform {
  INSTAGRAM
  FACEBOOK
  X
  TIKTOK
  LINKEDIN
  YOUTUBE
}

enum PostStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
  DELETED
}

enum PostItemStatus {
  PENDING
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
}

enum ConversationType {
  DM
  COMMENT
  MENTION
  REVIEW
}

enum ConversationStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum ConversationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum MessageFrom {
  USER
  BRAND
  SYSTEM
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

enum ContractStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum LeadSource {
  WEBSITE
  REFERRAL
  SOCIAL_MEDIA
  EMAIL
  COLD_CALL
  EVENT
  OTHER
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String? // For credentials auth
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts         Account[]
  sessions         Session[]
  memberships      Membership[]
  audits           Audit[]
  projectMembers   ProjectMember[]
  createdTasks     Task[]          @relation("CreatedTasks")
  assignedTasks    Task[]          @relation("AssignedTasks")
  taskComments     TaskComment[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// CLIENTS (CRM/ERP)
// ============================================

model Client {
  id         String   @id @default(cuid())
  name       String // Company name
  email      String?
  phone      String?
  address    String?
  city       String?
  postalCode String?
  country    String?  @default("Espa√±a")
  taxId      String? // NIF/CIF
  website    String?
  notes      String?  @db.Text
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  brands    Brand[]
  quotes    Quote[]
  contracts Contract[]
  leads     Lead[]
  projects  Project[]

  @@index([name])
  @@index([isActive])
  @@map("clients")
}

model Lead {
  id               String     @id @default(cuid())
  clientId         String? // Optional: can become a client later
  companyName      String
  contactName      String
  contactEmail     String?
  contactPhone     String?
  status           LeadStatus @default(NEW)
  source           LeadSource @default(OTHER)
  estimatedValue   Float?
  probability      Int        @default(50) // 0-100
  expectedCloseDate DateTime?
  notes            String?    @db.Text
  assignedTo       String? // User ID
  lastContactDate  DateTime?
  nextFollowUpDate DateTime?
  isActive         Boolean    @default(true)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  client Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([status, isActive])
  @@index([assignedTo])
  @@index([expectedCloseDate])
  @@map("leads")
}

// ============================================
// BRANDS & MEMBERSHIPS
// ============================================

model Brand {
  id        String   @id @default(cuid())
  clientId  String? // Optional: brand can exist without a client
  name      String
  logo      String?
  slug      String   @unique
  timezone  String   @default("Europe/Madrid")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client           Client?             @relation(fields: [clientId], references: [id], onDelete: SetNull)
  memberships      Membership[]
  socialAccounts   SocialAccount[]
  posts            Post[]
  conversations    Conversation[]
  audits           Audit[]
  oauthCredentials OAuthCredentials[]
  mediaAssets      MediaAsset[]
  reports          Report[]
  projects         Project[]
  tasks            Task[]

  @@index([slug])
  @@index([clientId])
  @@map("brands")
}

model Membership {
  id        String   @id @default(cuid())
  userId    String
  brandId   String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([userId, brandId])
  @@index([brandId, role])
  @@map("memberships")
}

// ============================================
// SOCIAL ACCOUNTS
// ============================================

model SocialAccount {
  id                 String   @id @default(cuid())
  brandId            String
  platform           Platform
  platformAccountId  String // External ID from the platform
  username           String
  displayName        String?
  avatar             String?
  accessToken        String   @db.Text // Encrypted
  refreshToken       String?  @db.Text // Encrypted
  tokenExpiresAt     DateTime?
  metadata           Json? // Platform-specific data
  isActive           Boolean  @default(true)
  lastSyncAt         DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  brand         Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  postItems     PostItem[]
  conversations Conversation[]
  dailyMetrics  AccountDailyMetrics[]

  @@unique([platform, platformAccountId])
  @@index([brandId, platform])
  @@index([brandId, isActive])
  @@map("social_accounts")
}

// ============================================
// POSTS & SCHEDULING
// ============================================

model Post {
  id          String     @id @default(cuid())
  brandId     String
  status      PostStatus @default(DRAFT)
  scheduledAt DateTime?
  publishedAt DateTime?
  createdById String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  brand     Brand      @relation(fields: [brandId], references: [id], onDelete: Cascade)
  items     PostItem[]
  approvals Approval[]

  @@index([brandId, status])
  @@index([brandId, scheduledAt])
  @@index([scheduledAt])
  @@map("posts")
}

model PostItem {
  id              String         @id @default(cuid())
  postId          String
  socialAccountId String
  platform        Platform
  content         String         @db.Text
  mediaUrls       String[] // Array of S3 URLs
  hashtags        String[]
  status          PostItemStatus @default(PENDING)
  externalPostId  String? // ID from the platform after publishing
  publishedAt     DateTime?
  failureReason   String?        @db.Text
  metadata        Json? // Platform-specific data
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  post          Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  socialAccount SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  metrics       PostMetrics[]

  @@index([postId])
  @@index([socialAccountId, status])
  @@index([status, publishedAt])
  @@map("post_items")
}

model PostMetrics {
  id         String   @id @default(cuid())
  postItemId String
  likes      Int      @default(0)
  comments   Int      @default(0)
  shares     Int      @default(0)
  views      Int      @default(0)
  reach      Int      @default(0)
  engagement Float    @default(0)
  clicks     Int      @default(0)
  saves      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  postItem PostItem @relation(fields: [postItemId], references: [id], onDelete: Cascade)

  @@index([postItemId])
  @@index([updatedAt])
  @@map("post_metrics")
}

model Approval {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  approved  Boolean
  comment   String?  @db.Text
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("approvals")
}

// ============================================
// INBOX & CONVERSATIONS
// ============================================

model Conversation {
  id                 String               @id @default(cuid())
  brandId            String
  socialAccountId    String
  platform           Platform
  type               ConversationType
  externalId         String // External conversation/thread ID
  fromUserId         String? // External user ID
  fromUsername       String
  fromDisplayName    String?
  fromAvatar         String?
  status             ConversationStatus   @default(NEW)
  priority           ConversationPriority @default(MEDIUM)
  sentiment          Sentiment?
  lastMessageAt      DateTime
  slaDeadline        DateTime?
  tags               String[]
  metadata           Json? // Platform-specific data
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  brand         Brand         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  socialAccount SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([platform, externalId])
  @@index([brandId, status])
  @@index([brandId, updatedAt])
  @@index([socialAccountId, status])
  @@map("conversations")
}

model Message {
  id             String      @id @default(cuid())
  conversationId String
  platform       Platform
  from           MessageFrom
  externalId     String // External message ID
  content        String      @db.Text
  mediaUrls      String[]
  metadata       Json?
  createdAt      DateTime    @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([platform, externalId])
  @@index([conversationId, createdAt])
  @@map("messages")
}

// ============================================
// ANALYTICS
// ============================================

model AccountDailyMetrics {
  id              String   @id @default(cuid())
  socialAccountId String
  date            DateTime @db.Date
  followers       Int      @default(0)
  following       Int      @default(0)
  posts           Int      @default(0)
  likes           Int      @default(0)
  comments        Int      @default(0)
  shares          Int      @default(0)
  views           Int      @default(0)
  reach           Int      @default(0)
  impressions     Int      @default(0)
  engagement      Float    @default(0)
  metadata        Json?
  createdAt       DateTime @default(now())

  socialAccount SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  @@unique([socialAccountId, date])
  @@index([socialAccountId, date])
  @@map("account_daily_metrics")
}

// ============================================
// AUDIT LOG
// ============================================

model Audit {
  id        String   @id @default(cuid())
  brandId   String
  userId    String?
  action    String // "post.publish", "account.connect", "inbox.reply", etc.
  resource  String? // Resource ID (postId, accountId, etc.)
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([brandId, createdAt])
  @@index([userId, createdAt])
  @@map("audits")
}

// ============================================
// OAUTH CREDENTIALS
// ============================================

model OAuthCredentials {
  id           String   @id @default(cuid())
  brandId      String
  platform     Platform
  clientId     String   @db.Text // Encrypted
  clientSecret String   @db.Text // Encrypted
  metadata     Json? // Additional platform-specific settings
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, platform])
  @@index([brandId, platform, isActive])
  @@map("oauth_credentials")
}

// ============================================
// MEDIA LIBRARY
// ============================================

model MediaAsset {
  id          String    @id @default(cuid())
  brandId     String
  publicId    String // Cloudinary public_id
  url         String    @db.Text
  format      String
  width       Int
  height      Int
  bytes       Int
  usedCount   Int       @default(0)
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, publicId])
  @@index([brandId, usedCount])
  @@index([brandId, lastUsedAt])
  @@map("media_assets")
}

// ============================================
// QUOTES & CONTRACTS (ERP)
// ============================================

model Quote {
  id           String      @id @default(cuid())
  quoteNumber  String      @unique // QUO-2025-001
  clientId     String
  title        String
  description  String?     @db.Text
  items        Json // Array of {description, quantity, unitPrice, total}
  subtotal     Float
  tax          Float       @default(0)
  discount     Float       @default(0)
  total        Float
  status       QuoteStatus @default(DRAFT)
  validUntil   DateTime?
  notes        String?     @db.Text
  createdById  String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  sentAt       DateTime?
  acceptedAt   DateTime?

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, status])
  @@index([quoteNumber])
  @@index([status, createdAt])
  @@map("quotes")
}

model Contract {
  id             String         @id @default(cuid())
  contractNumber String         @unique // CON-2025-001
  clientId       String
  title          String
  description    String?        @db.Text
  startDate      DateTime
  endDate        DateTime?
  value          Float
  billingCycle   String? // monthly, yearly, one-time
  status         ContractStatus @default(DRAFT)
  terms          String?        @db.Text
  notes          String?        @db.Text
  createdById    String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  signedAt       DateTime?

  client   Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  projects Project[]

  @@index([clientId, status])
  @@index([contractNumber])
  @@index([status, startDate])
  @@map("contracts")
}

// ============================================
// REPORTS
// ============================================

enum ReportStatus {
  GENERATING
  COMPLETED
  FAILED
  SCHEDULED
}

enum ReportFrequency {
  MANUAL
  WEEKLY
  MONTHLY
  QUARTERLY
}

model Report {
  id              String         @id @default(cuid())
  brandId         String
  reportNumber    String         @unique // REP-2025-001
  title           String
  type            String         @default("monthly") // monthly, weekly, custom
  status          ReportStatus   @default(GENERATING)
  startDate       DateTime
  endDate         DateTime
  generatedBy     String
  data            Json?          // Report data (metrics, posts, etc)
  settings        Json?          // Template settings, colors, etc
  pdfUrl          String?        // URL to generated PDF
  scheduledFor    DateTime?      // For auto-generated reports
  frequency       ReportFrequency @default(MANUAL)
  recipients      String[]       // Email addresses to send to
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId, createdAt])
  @@index([reportNumber])
  @@index([status, scheduledFor])
  @@map("reports")
}

// ============================================
// PROJECTS & TASKS
// ============================================

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Project {
  id          String        @id @default(cuid())
  clientId    String?
  contractId  String?
  brandId     String?
  name        String
  description String?       @db.Text
  status      ProjectStatus @default(PLANNING)
  startDate   DateTime
  endDate     DateTime?
  budget      Float?
  budgetHours Int?
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  client   Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  contract Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)
  brand    Brand?    @relation(fields: [brandId], references: [id], onDelete: SetNull)
  tasks    Task[]
  members  ProjectMember[]

  @@index([clientId, status])
  @@index([brandId, status])
  @@index([status, startDate])
  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String?
  addedAt   DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

model Task {
  id          String       @id @default(cuid())
  projectId   String?
  brandId     String?
  title       String
  description String?      @db.Text
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  assignedTo  String?
  dueDate     DateTime?
  position    Int          @default(0)
  tags        String[]
  createdById String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  project     Project?          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  brand       Brand?            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  assignee    User?             @relation("AssignedTasks", fields: [assignedTo], references: [id], onDelete: SetNull)
  creator     User              @relation("CreatedTasks", fields: [createdById], references: [id])
  checkItems  TaskCheckItem[]
  comments    TaskComment[]
  attachments TaskAttachment[]

  @@index([projectId, status])
  @@index([brandId, status])
  @@index([assignedTo, status])
  @@index([status, position])
  @@map("tasks")
}

model TaskCheckItem {
  id        String   @id @default(cuid())
  taskId    String
  title     String
  completed Boolean  @default(false)
  position  Int      @default(0)
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("task_check_items")
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([taskId, createdAt])
  @@map("task_comments")
}

model TaskAttachment {
  id         String   @id @default(cuid())
  taskId     String
  name       String
  url        String
  fileType   String
  fileSize   Int
  uploadedBy String
  createdAt  DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("task_attachments")
}
